
<!DOCTYPE html>
<!--[if lte IE 6 ]><html class="ie ielt9 ielt8 ielt7 ie6" lang="en-GB"><![endif]-->
<!--[if IE 7 ]><html class="ie ielt9 ielt8 ie7" lang="en-GB"><![endif]-->
<!--[if IE 8 ]><html class="ie ielt9 ie8" lang="en-GB"><![endif]-->
<!--[if IE 9 ]><html class="ie ie9" lang="en-GB"><![endif]-->
<!--[if (gt IE 9)|!(IE)]><!--><html lang="en-GB"><!--<![endif]-->
	<head>
		<meta charset="utf-8">
<title>Fixing Maven JSPC Issues with Java 7 on OSX</title>
<meta name="description" content="">
<meta name="author" content="Dustin Talk">
<meta name="keywords" content="ecommerce, java, opensource, dallas, consulting, hacking, security" />
<meta name="copyright" content="All content (c) Copyright Dustin Talk" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<meta name="apple-mobile-web-app-capable" content="yes" />
<meta property="og:title" content="Dustin Talk" />
<meta property="og:type" content="website" />
<meta property="og:site_name" content="Dustin Talk"/>
<meta property="og:image" content="http://dwtalk.github.com/assets/themese/dwtalk/img/dwtalk.jpg" />
<meta property="og:description" content="Dustin Talk is an eCommerce Architect/Consultant in Addison TX" />
<meta name="twitter:card" content="summary">
<meta name="twitter:creator" content="@DustinTalk">
<meta name="twitter:title" content="Dustin Talk Blog">
<meta name="twitter:description" content="Dustin Talk eCommerce Consultant Architect">
<meta name="twitter:image" content="http://dwtalk.github.com/assets/themese/dwtalk/img/dwtalk.jpg">

<link href="/assets/themes/dwtalk/css/bootstrap.min.css" rel="stylesheet">
<link href="/assets/themes/dwtalk/css/bootstrap-responsive.min.css" rel="stylesheet" type="text/css" />
<link href="/assets/themes/dwtalk/css/dt.css" rel="stylesheet" type="text/css"  media="all" />
<link rel="shortcut icon" href="/favicon.ico">
<link rel="apple-touch-icon" href="favicon.png">
<link rel="apple-touch-icon" sizes="72x72" href="favicon-72x72.png">
<link rel="apple-touch-icon" sizes="114x114" href="favicon-114x114.png">
<link href="/atom.xml" type="application/atom+xml" rel="alternate" title="Sitewide ATOM Feed">
<link href="/rss.xml" type="application/rss+xml" rel="alternate" title="Sitewide RSS Feed">

<!--[if lt IE 9]>
  <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
<![endif]-->
<script defer src="/assets/themes/dwtalk/js/modernizr.js" type="text/javascript"></script>
<script defer src="http://platform.linkedin.com/in.js" type="text/javascript">
  api_key: su9lhot8uatl
  authorize: true
</script>
<script src="//ajax.googleapis.com/ajax/libs/jquery/1.8.1/jquery.min.js" type="text/javascript"></script>
<script src="//code.jquery.com/color/jquery.color-2.1.1.min.js"></script>

	</head>
	<body data-spy="scroll" data-target=".bs-docs-sidebar" data-twttr-rendered="true">
		<div class="navbar navbar-inverse navbar-fixed-top">
	<div class="navbar-inner">
		<div class="container">
			<ul class="nav">
				<li style="padding: 0; margin: 0; height: 40px;">
					<canvas id="iframe-chil-logo-canvas" style="padding: 0; margin: 0;" width="55" height="40"></canvas>
					<img id="chilback" src="/assets/themes/dwtalk/img/chilback.png" onclick="window.location = '/';" alt="Home">
				</li>
				
	            
	            


  
    
      
      	
      	<li><a href="/about.html"
		 class="no-ajaxy" 
		
		
		
		
		
		
		>About</a></li>
      	
      
    
  
    
      
    
  
    
      
    
  
    
      
      	
      	<li><a href="/blog.html"
		
		
		
		
		
		
		
		>Blog</a></li>
      	
      
    
  
    
      
    
  
    
      
    
  
    
      
    
  
    
      
    
  
    
      
    
  
    
      
    
  



			</ul>
		</div>
	</div>
</div>
		<div class="topper">
	<header class="htop">
		<h1 class="name">DUSTIN TALK</h1>
		<span class="desc">Consultant,Architect,Hacker,<span id="geek">Geek</span></span>
		<ul class="social-links scard">
			<li class="linkedin"><a href="http://www.linkedin.com/in/dustintalk">linkedin</a></li>
			<li class="twitter"><a href="https://twitter.com/intent/follow?original_referer=&amp;region=follow_link&amp;screen_name=DustinTalk&amp;tw_p=followbutton&amp;variant=2.0">Twitter</a></li>
			<li class="email"><a href="http://kontactr.com/user/dwtalk">email</a></li>
			<li class="github"><a href="https://github.com/dwtalk">github</a></li>
			<li class="googleplus"><a href="https://profiles.google.com/dwtalk">googleplus</a></li>
		</ul>
	</header>
</div>
		<div id="container">
        	
<div class="post">
	<article>
  <h1>Fixing Maven JSPC Issues with Java 7 on OSX <small>w/ Jenkins</small></h1>

    <div class="date">
      <span>18 April 2013</span>
    </div>

<div class="tagbar">
  
      <i class="icon-folder-open"></i>
      
      


  
     
    	<span class="label label-info"><a href="/categories.html#java-ref">java 2</a></span>
    
  


    

  
      <i class="icon-tags"></i>
      
      


  
     
    	<span class="badge"><a href="/tags.html#java-ref">java 2</a></span>
     
    	<span class="badge"><a href="/tags.html#osx-ref">osx 2</a></span>
    
  



  
</div>

<!-- AddThis Button BEGIN -->
<div class="addthis_toolbox addthis_default_style addthis_16x16_style">
<a class="addthis_button_hackernews"></a>
<a class="addthis_button_google_plusone_share"></a>
<a class="addthis_button_twitter"></a>
<a class="addthis_button_linkedin"></a>
<a class="addthis_button_pinterest_share"></a>
</div>
<div id="scriptwrite">&nbsp;
	<script type="text/javascript" src="//s7.addthis.com/js/300/addthis_widget.js#pubid=undefined"></script>
</div>
<!-- AddThis Button END -->

      
<p>Running on the latest technology platform has it’s risks and rewards, but Java 7 on OSX has been out for a while now and I would expect JSPC to work correctly as well. I present a simple method for patching the system as well as correcting the code and giving back to open source development.</p>

<h3 id="the-error">The Error</h3>
<p>When compiling an existing application I have on OSX Mountain Lion using <code>Java 7.0.17</code> and <code>Jenkins 1.5.0</code> on <code>Maven 3.0.5</code>, I ran into the following error:</p>

<pre><code>Exception in thread "main" java.lang.AssertionError: Missing tools.jar at: /Library/Java/JavaVirtualMachines/jdk1.7.0_17.jdk/Contents/Home/Classes/classes.jar. Expression: file.exists()
</code></pre>

<div class="row text-center">
	<img src="http://dl.dropbox.com/u/15524812/Screenshots/00.png" width="680" alt="Java Error" />
</div>

<h3 id="the-workaround">The Workaround</h3>

<p>With the introduction of Java 7, tools.jar has been separated out of the classes.jar with (located in the lib directory of the jdk) and all classes are now stored in the runtime jar rt.jar located in the jre’s lib directory. We can help bypass this shortcoming with the following by creating a symbolic link for the jspc compiler:</p>

<pre><code>$ cd /Library/Java/JavaVirtualMachines/jdk1.7.0_17.jdk/Contents/Home/
$ sudo mkdir Classes
$ sudo ln -s ../jre/lib/rt.jar classes.jar
</code></pre>

<h3 id="the-solution">The Solution</h3>
<p>As an open source user and developed, it’s simply not enough to create a work-around, I want to know how to perm fix this issue. Time to dig into the code.
Looking through the plugin code, available <a href="https://svn.codehaus.org/mojo/tags/jspc-maven-plugin-1.4.6/src/main/java/org/codehaus/mojo/jspc/AbstractJspcMojo.java">here</a>, it appears that whenever Mac OSX is detected we assume classes.jar will be available, as this is how it has been with Java 6 and prior.</p>

<pre><code>// Find the tools.jar and add it to the classpath
String toolsJar = null;
if (System.getProperty("os.name").equals("Mac OS X")) {
  toolsJar = System.getProperty("java.home")
    + "/../Classes/classes.jar";
} else {
  toolsJar = System.getProperty("java.home") + File.separatorChar
  + ".." + File.separatorChar + "lib"
  + File.separatorChar + "tools.jar";
}
</code></pre>

<p>To help fix the code a little, we just need to make the following corrections:</p>

<ul>
  <li>If we are on a mac, detect the java version</li>
  <li>If the version is java 7, then we have two options, use the jdk tools.jar or the rt.jar in the JRE. Although we used the rt.jar before, I would rather stick to the JDK and not presume the jre exists.</li>
</ul>

<p>The code change would look a little something like this:</p>

<pre><code>// Find the tools.jar and add it to the classpath
String toolsJar = null;
if (System.getProperty("os.name").equals("Mac OS X")) {
  if(System.getProperty("java.version").compareTo("1.7") &gt;= 0) {
	toolsJar = System.getProperty("java.home")
    + "/../lib/tools.jar"; 
  } else {
	toolsJar = System.getProperty("java.home")
    + "/../Classes/classes.jar";
  }
} else {
  	  toolsJar = System.getProperty("java.home") + File.separatorChar
  + ".." + File.separatorChar + "lib"
  	  + File.separatorChar + "tools.jar";
}
</code></pre>

<p>Let’s not stop there either, version 2.0 is in alpha 3 status, and written in groovy no-less. The code for this release is located here, and looks a little different:</p>

<pre><code>/**
 * Figure out where the tools.jar file lives.
 */
private File findToolsJar() {
  def javaHome = new File(System.properties['java.home'])
  
  def file
  if (SystemUtils.IS_OS_MAC_OSX) {
    file = new File(javaHome, '../Classes/classes.jar').canonicalFile
  }
  else {
    file = new File(javaHome, '../lib/tools.jar').canonicalFile
  }
    
  assert file.exists() : "Missing tools.jar at: $file"
    
  log.debug("Using tools.jar: $file")
    
  return file
}
</code></pre>

<p>Whilst I am not as proficient in groovy as I am java, a few simple tweaks should fix this file as well:</p>

<pre><code>/**
 	* Figure out where the tools.jar file lives.
 	*/
private File findToolsJar() {
  	  def javaHome = new File(System.properties['java.home'])
  def isJavaSeven = System.properties['java.version'].split ( /\./ )[1] &gt; '6'

  def file
  if (SystemUtils.IS_OS_MAC_OSX &amp;&amp; !isJavaSeven) {
    file = new File(javaHome, '../Classes/classes.jar').canonicalFile
  }
  else {
    file = new File(javaHome, '../lib/tools.jar').canonicalFile
  }

  assert file.exists() : "Missing tools.jar at: $file"

  log.debug("Using tools.jar: $file")

  return file
}
</code></pre>

<p>Fixed and submitted to the Codehaus Jira Ticket.</p>

<p>With some simple investigation, we found a workaround to a rather annoying error specific to Mac OSX, the JSPC Maven Plugin and Java 7. With a little more time, hopefully we are able to give a little back to the community of open source my lively-hood relies on. I encourage you to do the same, find a bug, fix it, document it, and submit it for the better of the community.</p>





    <hr>
    <div class="pager">
      <ul>
      
        <li class="previous"><a href="/consulting/2013/04/09/learnings-from-the-cias-corporate-sabotage-cheatsheet" title="Learnings from the CIA's Corporate Sabotage Cheatsheet">&larr; Previous</a></li>
      
      
        <li class="next disabled"><a>Next &rarr;</a></li>
      
      </ul>
    </div>
    <hr>
	<div class="hideltie7">
    	


  <div id="disqus_thread"></div>
<script type="text/javascript">
    var disqus_developer = 1;
    var disqus_shortname = 'dustinwtalk'; // required: replace example with your forum shortname
    
    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">blog comments powered by <span class="logo-disqus">Disqus</span></a>




	</div>
</article>
</div>

			<div class="retopbg">
				<div class="retop">
					<a href="#container" class="no-ajaxy">Return to top</a>
				</div>
			</div>
		</div>
		<footer class="footer">
	   		<div class="footlink">
	<div class="span3">
		<ul>
			<li><a href="/">Dustin Talk</a></li>
			<li><a href="/blog.html">Blog</a></li>
			<li><a href="/about.html" class="no-ajaxy">About</a></li>
		</ul>
	</div>
	<div class="span3">
		<ul>
			<li><a href="/archive.html">Archive</a></li>
			<li><a href="/pages.html">Pages</a></li>
			<li><a href="/categories.html">Categories</a></li>
			<li><a href="/tags.html">Tags</a></li>
		</ul>
	</div>
	<div class="span3">
		<ul>
			<li><a href="/atom.xml" class="no-ajaxy">Atom Feed</a></li>
			<li><a href="/sitemap.txt" class="no-ajaxy">Sitemap</a></li>
			<li><a href="/rss.xml" class="no-ajaxy">RSS Feed</a></li>
		</ul>
	</div>
</div>
		</footer>
		<!--[if (gt IE 8)|!(IE)]><!-->
<script type="text/javascript" defer src="/assets/themes/dwtalk/js/chillogo.min.js"></script>
<script type="text/javascript" defer src="/assets/themes/dwtalk/js/chillogo.util.min.js"></script>
<script type="text/javascript" defer src="/assets/themes/dwtalk/js/chillogo.init.min.js"></script>
 <!--<![endif]-->
<script defer src="//balupton.github.com/jquery-scrollto/scripts/jquery.scrollto.min.js" type="text/javascript"></script>
<script defer src="//browserstate.github.com/history.js/scripts/bundled/html4+html5/jquery.history.js" type="text/javascript"></script>
<script defer src="/assets/themes/dwtalk/js/ajaxify-html5.js" type="text/javascript"></script> 
<script defer src="/assets/themes/dwtalk/js/bootstrap.min.js" type="text/javascript"></script>
    	
	</body>
</html>


